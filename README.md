# 发票合并调整工具 - 专业版 (PDF Merger Pro v3)

一个功能强大的本地化 PDF 处理工具，基于 Python (`pywebview`) 构建。不仅支持可视化的 PDF 合并与编辑，还集成了智能化的发票报销辅助功能。

## 🌟 主要功能

### 1. PDF 可视化处理

- **工作台模式**：直观的网格视图，支持拖拽排序、框选多选。
- **实时预览**：
  - **缩略图秒开**：利用缓存机制，源文件列表点击即开。
  - **渐进式高清预览**：双击卡片或查看历史记录时，先加载低清图垫底，后台加载 5.0x 高清图，拒绝白屏等待。
- **编辑功能**：支持对单页或多页进行旋转（左旋/右旋）、删除操作。

### 2. 多模式合并

- **普通合并**：按顺序将所有页面合并为一个 PDF 文件。
- **发票合并**：专为发票打印设计，自动将两张 A5/小页面的发票合并到一张 A4 页面上（上下排列）。

### 3. 💰 智能报销助手 (新功能)

- **自动提取金额**：基于 `PyMuPDF` 自动识别电子发票（交通/客运类）的价税合计金额。
- **路线智能匹配**：根据预设的「地点-金额」配置，自动匹配最接近的发票路线（如：公司 -> 市建委）。
- **智能填表**：
  - 支持自定义报销日期范围（如 "2025年7-12月"），自动避开周末，随机分配工作日。
  - 根据金额大小自动计算同行人数（30元以下1人，100元以下2人等）。
- **数据导出**：
  - **复制到 Excel**：一键复制表格数据，直接粘贴进 Excel 即可自动分列。
  - **保存 CSV**：支持导出标准的 CSV 报销单文件，包含自动计算的合计行。

## 📂 项目结构

为了便于维护，项目代码进行了模块化拆分：


| 文件名              | 说明                                                                          |
| :------------------ | :---------------------------------------------------------------------------- |
| **`pdfm_v3.py`**    | **主程序入口**。负责 GUI 窗口创建、API 接口定义以及 Python 与 JS 的交互逻辑。 |
| **`filltable.py`**  | **报销逻辑模块**。负责发票金额解析、路线匹配算法、日期生成及配置文件管理。    |
| **`ui.py`**         | **界面资源模块**。存放所有的 HTML、CSS 和 JavaScript 代码，保持主程序整洁。   |
| `route_config.json` | 自动生成的配置文件，存储用户的自定义报销路线信息。                            |
| `pdfm_v1.py`        | 历史版本（功能基础，仅供参考）。                                              |
| `pdfm_v2.py`        | 历史版本（增加了编辑功能，但 UI 较旧）。                                      |

## 🚀 安装与运行

### 1. 环境要求

- Python 3.8+
- 推荐使用 Windows 系统（已针对文件路径做优化）

### 2. 安装依赖

本项目已移除 `pdfplumber`，全面拥抱 `PyMuPDF` (fitz) 以获得更快的速度。

```bash
pip install pywebview PyMuPDF PyPDF2
```

### 3. 运行程序

直接运行 v3 版本即可体验最新功能：

```bash
python pdfm_v3.py
```

## 📖 使用指南

### 基础合并

1. 点击左上角 **"+ 添加PDF文件"**。
2. 在工作台中通过拖拽调整顺序，或使用框选/Ctrl+点击进行旋转或删除。
3. 点击右下角 **"合并并保存"**。

### 报销单生成（发票模式）

1. 在工具栏选择 **"发票合并"** 模式。
2. 点击出现的 **"配置路线"** 按钮，录入常用的行程及大致金额（如：公司-西三环-10元）。
3. 导入多张电子发票 PDF。
4. 在底部批量操作栏中点击 **"📝 填写报销单"**。
5. 输入报销时间段（如 `2025年10月` 或 `2025年10-12月`）。
6. 系统生成表格后，可选择 **"复制 (Excel)"** 或 **"保存 CSV"**。

## 🛠️ 技术亮点

- **UI/Logic 分离**：界面代码存放于 `ui.py`，逻辑清晰。
- **Lazy Loading (懒加载)**：列表检查模式下使用 `IntersectionObserver`，仅当图片进入视口时才渲染，极大降低内存占用。
- **Blur-up 技术**：预览大图时优先显示低清缩略图，视觉体验极佳。
- **纯原生依赖**：剪贴板复制功能兼容 HTTP/HTTPS 及本地环境，无需额外系统库。

## 📝 更新日志

**v3.1.0**

- ✨ 代码重构：将 HTML 拆分至 `ui.py`。
- ✨ 新增报销单生成器模块 (`filltable.py`)。
- ✨ 增加 CSV 导出和 Excel 复制功能，包含自动合计。
- ⚡️ 优化：移除 `pdfplumber` 依赖，完全使用 `fitz` 进行文本和图像处理。

**v3.0.0**

- 🎨 UI 全面升级：引入卡片式设计、批量操作栏。
- ⚡️ 性能优化：解决大文件预览白屏问题，引入智能清晰度控制。

---

*Developed with ❤️ using Python & pywebview.***直接运行 v3 版本即可体验最新功能：**
